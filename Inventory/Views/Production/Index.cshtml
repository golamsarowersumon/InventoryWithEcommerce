

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="modal fade" id="modal-animation-3" style="display: none;" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated zoomInUp">
            <div class="modal-header">
                <h5 class="modal-title">Message</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="Reload()" data-dismiss="modal">Ok</button>
            </div>
        </div>
    </div>
</div>






<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <form id="signupForm" novalidate="novalidate">
                    <h4 class="form-header text-uppercase">
                        <i class="fa fa-address-book-o"></i>
                        Production Process
                    </h4>

                    <div class="col-lg-12">
                        <div class="col-sm-12 col-md-4 form-group row">
                            <label for="input-14" class="col-sm-4 col-md-4 col-form-label">Product</label>
                            <div class="col-sm-8 col-md-8">
                                <select id="ddlproduct" class="form-control">
                                    <option value="">Select Product</option>
                                </select>
                                <p class="pid" style="color:#f50909"></p>
                            </div>
                        </div>
                        @*<div class="col-sm-12 col-md-4 form-group row">
                            <label for="input-14" class="col-sm-4 col-md-4 col-form-label">Store</label>
                            <div class="col-sm-8 col-md-8">
                                <select id="ddlstore" class="form-control">
                                    <option value="">Select Store</option>
                                </select>
                                <p class="stid" style="color:#f50909"></p>
                                
                            </div>
                        </div>*@
                        <div class="col-sm-12 col-md-4 form-group row">
                            <label for="input-14" class="col-sm-4 col-md-4 col-form-label">Quantity</label>
                            <div class="col-sm-8 col-md-8">
                                <input type="number" class="form-control" id="txtqty" min="0">
                                <p class="qty" style="color:#f50909"></p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <button type="button" id="calculate" class="btn btn-success"><i class="fa fa-check-square-o"></i>Calculate Production</button>
                        <button type="button" id="btnsave" class="btn btn-success"><i class="fa fa-check-square-o"></i>Save</button>
                        <button type="button" id="refress" onclick="Reload()" class="btn btn-danger"><i class="fa fa-times"></i>Refres</button>
                    </div>
                    <hr />


                    <h5 class="card-title">Details</h5>
                    <div class="table-responsive" style="height:260px">
                        <table id="tbl" class="table table-bordered">
                            <thead>
                                <tr>
                                    
                                    <th>Item</th>
                                    <th>Required Quantity</th>
                                    <th>Price Per Unit</th>
                                    <th>Unit Type</th>
                                    <th>Sub Total</th>
                                    <th>Availability Check</th>
                                    <th>Available Stock</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="4" style="text-align:right">Total</th>
                                    <th id="tot"></th>
                                    <th colspan="2"></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>


@section Scripts{

    <script>
        $(document).ready(function () {
            LoadProduct();
          
            $("#btnsave").hide();
            $("#calculate").click(function () {
                $("#btnsave").hide();
                CAlculation();
            })
           
        })



      
        function LoadProduct() {
            $.ajax({

                url: "/Production/GetProduct",
                type: "Get",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (data) {
                    //console.log(data);
                    for (var i = 0; i < data.length; i++) {

                        $("#ddlproduct").append("<option value=" + data[i].ProductId + ">" + data[i].ProductName + "</option>")
                    }
                },
                error: function (errormessage) {
                    //alert(errormessage.responseText);
                }

            });

        }

      

        function validateForm() {
            var Proid = $("#ddlproduct").val();
            //var stoid = $("#ddlstore").val();

            var CalQty = $("#txtqty").val();

            var inputVal = new Array(Proid, CalQty);
         
            var inputMessage = new Array("Product", "Quantity");

            $('.error').hide();

            if (inputVal[0] == "") {
                $('.pid').after('<span class="error"> Please enter' + inputMessage[0] + '</span>');
                return false;
            }

            //if (inputVal[1] == "") {
            //    $('.stid').after('<span class="error"> Please enter' + inputMessage[1] + '</span>');
            //    return false;
            //}

            if (inputVal[1] == "") {
                $('.qty').after('<span class="error"> Please enter' + inputMessage[2] + '</span>');
                return false;
            }
            else if (inputVal[2] <= 0){
                $('.qty').after('<span class="error">Quantity Greater Than Zero</span>');
            }
            else {
                return true;
            }
        }




        var sum = 0;

      
        function CAlculation() {

            if (validateForm()) {

            var id = $("#ddlproduct").val();
            var AP = $("#txtqty").val();


            $.ajax({
                url: "/Production/GetProductionElement?id=" + id,
                type: "Get",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (data) {
                    //console.log(data);
                    if (data.isRedirect) {
                        window.location.href = data.redirectUrl;
                    }
                    else {

                        sum = 0;
                        var d = [];
                        d.length = 0;


                        $("#tbl tbody").empty();
                        for (var i = 0; i < data.length; i++) {

                            if (data[i].Msg == null) {




                                var gg = (AP * data[i].ItemQuantity) / data[i].ProductQuantity
                                var ff = data[i].AvailableQty
                                var subtotal = gg * data[i].PO_Price



                                sum += subtotal

                                var c = ff - gg

                                d.push(c)

                                $("#tot").text(sum);
                                if (gg <= ff) {
                                    var msg = "Available"

                                }
                                else {

                                    var msg = "<p>You Dont Have Sufficient</p><p>Material in your Store</p><p><button type='button' class='btn btn-success btn-sm waves-effect waves-light m -1'>Request</button></p>"

                                }

                                $("#tbl tbody").append(
                                    "<tr><td><input type='text' id='iid' hidden value='" + data[i].ItemId + "' />" + data[i].ItemName
                                    + "</td><td><input type='text' id='itmqty' value='" + gg + "' readonly />"
                                    + "</td><td><input type='text' id='itmprice' value='" + data[i].PO_Price + "' readonly />" + "</td><td>" + data[i].UnitName
                                    + "</td><td>" + subtotal + "</td><td>" + msg + "</td><td>" + ff + "</td></tr>"
                                )



                            } else {
                                $("#modal-animation-3").modal("toggle");
                                $(".modal-body").html(data[i].Msg);
                            }
                        }


                        for (var a of d) {
                            if (a < 0)

                                return false;
                        }

                        $("#btnsave").show();
                        return true;

                    }
                  
                },
                error: function (errormessage) {
                    //alert(errormessage.responseText);
                }

                });


            }
        }





        var mainarr = [];

        //Add Data Purchase
        function Add(data) {
           
            $.ajax({

                url: "/Production/Save",
                type: "POST",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                data: data,
                success: function () {
                    $("#modal-animation-3").modal("toggle");
                    $(".modal-body").html("Production Process Successfully Save");
                    
                },
                error: function (errormessage) {
                    //alert(errormessage.responseText);
                }

            });
        }
        $("#btnsave").click(function (e) {

            e.preventDefault();
            if (validateForm()) {

                var mainTable = $('#tbl');
                var tr = mainTable.find('tbody tr');

                tr.each(function () {


                    var itemId = $(this).find('#iid').val();
                    var itemqty = $(this).find('#itmqty').val();
                    var itemprice = $(this).find('#itmprice').val();

                    var item = {
                        ItemId: itemId, ItemQty: itemqty, ItemPrice: itemprice, subtotal: itemqty * itemprice
                    }
                    mainarr.push(item);

                });



                var productionarray = [];
                productionarray.length = 0;
                $.each(mainarr, function (i, v) {
                    productionarray.push({
                        ItemId: v.ItemId,
                        ItemQuantity: v.ItemQty,
                        ItemCost: v.ItemPrice,
                        SubTotal: v.subtotal
                    })
                })
                console.log(productionarray);
                var data = JSON.stringify({

                    ProductId: $("#ddlproduct").val(),
                    ProductionQuantity: $("#txtqty").val(),
                    StoreId: $("#ddlstore").val(),
                    ProductPrice: sum,
                    productionDetailsViewModels: productionarray

                });


                $.when(Add(data)).then(function (response) {
                    console.log(response);
                }).fail(function (err) {
                    consol.log(err);
                })
            }
        })

        function Reload() {
            location.reload(true);
        }
    </script>


}